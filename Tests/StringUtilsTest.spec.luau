local StringUtils = require("../Source/Commandline/Helpers/StringUtils")

return function()
    describe("StringUtils.capitalizeFirstLetter", function()
        it("should capitalize the first letter of a string", function()
            expect(StringUtils.capitalizeFirstLetter("hello")).to.equal("Hello")
            expect(StringUtils.capitalizeFirstLetter("world")).to.equal("World")
        end)

        it("should not change already capitalized strings", function()
            expect(StringUtils.capitalizeFirstLetter("Hello")).to.equal("Hello")
        end)

        it("should handle single character strings", function()
            expect(StringUtils.capitalizeFirstLetter("a")).to.equal("A")
            expect(StringUtils.capitalizeFirstLetter("Z")).to.equal("Z")
        end)

        it("should return empty string for empty input", function()
            expect(StringUtils.capitalizeFirstLetter("")).to.equal("")
        end)

        it("should only capitalize first letter, leave rest unchanged", function()
            expect(StringUtils.capitalizeFirstLetter("hELLO")).to.equal("HELLO")
            expect(StringUtils.capitalizeFirstLetter("test123")).to.equal("Test123")
        end)
    end)

    describe("StringUtils.isAlphanumericLowercase", function()
        it("should return true for valid lowercase alphanumeric strings", function()
            expect(StringUtils.isAlphanumericLowercase("hello")).to.equal(true)
            expect(StringUtils.isAlphanumericLowercase("test123")).to.equal(true)
            expect(StringUtils.isAlphanumericLowercase("abc123xyz")).to.equal(true)
            expect(StringUtils.isAlphanumericLowercase("123")).to.equal(true)
        end)

        it("should return false for strings with uppercase letters", function()
            expect(StringUtils.isAlphanumericLowercase("Hello")).to.equal(false)
            expect(StringUtils.isAlphanumericLowercase("TEST")).to.equal(false)
            expect(StringUtils.isAlphanumericLowercase("aBc")).to.equal(false)
        end)

        it("should return false for strings with special characters", function()
            expect(StringUtils.isAlphanumericLowercase("hello-world")).to.equal(false)
            expect(StringUtils.isAlphanumericLowercase("test_123")).to.equal(false)
            expect(StringUtils.isAlphanumericLowercase("hello world")).to.equal(false)
            expect(StringUtils.isAlphanumericLowercase("test!")).to.equal(false)
        end)

        it("should return false for empty strings", function()
            expect(StringUtils.isAlphanumericLowercase("")).to.equal(false)
        end)
    end)

    describe("StringUtils.assertAlphanumericLowercase", function()
        it("should return the string when valid", function()
            expect(StringUtils.assertAlphanumericLowercase("hello", "Test")).to.equal("hello")
            expect(StringUtils.assertAlphanumericLowercase("test123", "Field")).to.equal("test123")
        end)

        it("should throw error for invalid strings", function()
            expect(function()
                StringUtils.assertAlphanumericLowercase("Hello", "Name")
            end).to.throw()

            expect(function()
                StringUtils.assertAlphanumericLowercase("test-123", "Field")
            end).to.throw()

            expect(function()
                StringUtils.assertAlphanumericLowercase("", "Empty")
            end).to.throw()
        end)

        it("should include field name in error message", function()
            local success, err = pcall(function()
                StringUtils.assertAlphanumericLowercase("Invalid!", "MyField")
            end)
            expect(success).to.equal(false)
            expect(err:find("MyField")).to.be.ok()
        end)
    end)

    describe("StringUtils.tokenize", function()
        it("should tokenize simple space-separated strings", function()
            local tokens, err = StringUtils.tokenize("foo bar baz")
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(3)
            expect(tokens[1]).to.equal("foo")
            expect(tokens[2]).to.equal("bar")
            expect(tokens[3]).to.equal("baz")
        end)

        it("should handle multiple spaces", function()
            local tokens, err = StringUtils.tokenize("foo   bar")
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(2)
            expect(tokens[1]).to.equal("foo")
            expect(tokens[2]).to.equal("bar")
        end)

        it("should handle quoted strings as single tokens", function()
            local tokens, err = StringUtils.tokenize('foo "bar baz"')
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(2)
            expect(tokens[1]).to.equal("foo")
            expect(tokens[2]).to.equal("bar baz")
        end)

        it("should handle escaped quotes within quoted strings", function()
            local tokens, err = StringUtils.tokenize('foo "bar \\"quoted\\" baz"')
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(2)
            expect(tokens[1]).to.equal("foo")
            expect(tokens[2]).to.equal('bar "quoted" baz')
        end)

        it("should handle escaped backslashes", function()
            local tokens, err = StringUtils.tokenize('foo "bar\\\\baz"')
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(2)
            expect(tokens[1]).to.equal("foo")
            expect(tokens[2]).to.equal("bar\\baz")
        end)

        it("should handle unknown escape sequences literally", function()
            local tokens, err = StringUtils.tokenize('foo "bar\\nbaz"')
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(2)
            expect(tokens[2]).to.equal("bar\\nbaz")
        end)

        it("should return error for unclosed quotes", function()
            local tokens, err = StringUtils.tokenize('foo "bar baz')
            expect(#tokens).to.equal(0)
            expect(err).to.be.ok()
            expect(err:find("Unclosed quote")).to.be.ok()
        end)

        it("should return error for trailing backslash", function()
            local tokens, err = StringUtils.tokenize("foo bar\\")
            expect(#tokens).to.equal(0)
            expect(err).to.be.ok()
            expect(err:find("Trailing backslash")).to.be.ok()
        end)

        it("should handle empty strings", function()
            local tokens, err = StringUtils.tokenize("")
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(0)
        end)

        it("should handle strings with only whitespace", function()
            local tokens, err = StringUtils.tokenize("   ")
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(0)
        end)

        it("should handle mixed quoted and unquoted tokens", function()
            local tokens, err = StringUtils.tokenize('command --flag "value with spaces" arg')
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(4)
            expect(tokens[1]).to.equal("command")
            expect(tokens[2]).to.equal("--flag")
            expect(tokens[3]).to.equal("value with spaces")
            expect(tokens[4]).to.equal("arg")
        end)

        it("should preserve whitespace inside quotes", function()
            local tokens, err = StringUtils.tokenize('"  spaces  "')
            expect(err).to.equal(nil)
            expect(#tokens).to.equal(1)
            expect(tokens[1]).to.equal("  spaces  ")
        end)
    end)
end
